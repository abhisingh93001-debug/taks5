<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Clone Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e5ddd5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #075e54; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #status-info { font-size: 12px; color: #dcf8c6; }
        #setup-area { padding: 15px; background: white; text-align: center; border-bottom: 1px solid #ccc; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Message Bubbles */
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; position: relative; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .received { background: white; align-self: flex-start; border-top-left-radius: 0; }
        .sent { background: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; }
        
        /* Ticks Style */
        .tick { font-size: 12px; margin-left: 5px; color: #888; }
        .seen { color: #34b7f1; } /* Blue Ticks */

        .input-area { padding: 10px; background: #f0f0f0; display: flex; align-items: center; gap: 10px; }
        input { flex: 1; padding: 12px; border: none; border-radius: 25px; outline: none; font-size: 15px; }
        button { background: #075e54; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        #typing-indicator { font-style: italic; font-size: 13px; color: #075e54; padding: 2px 15px; height: 20px; }
        .video-container { display: flex; background: #000; justify-content: center; }
        video { width: 120px; height: 160px; object-fit: cover; border: 1px solid #555; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <strong>OnlineShop</strong><br>
        <span id="status-info">डिस्कनेक्टेड</span>
    </div>
    <div id="typing-indicator"></div>
</div>

<div id="setup-area">
    <small>आपकी ID: <b id="my-id">...</b></small> <br>
    <input type="text" id="peer-id" placeholder="दोस्त की ID" style="width: 150px; padding: 5px; margin-top: 5px;">
    <button onclick="connectToPeer()" style="width: auto; height: auto; border-radius: 5px; padding: 5px 10px; display: inline;">Connect</button>
    <button onclick="startVideoCall()" style="width: auto; height: auto; border-radius: 5px; padding: 5px 10px; display: inline; background: #128C7E;">Call</button>
</div>

<div class="video-container" id="v-con" style="display: none;">
    <video id="local-video" autoplay muted></video>
    <video id="remote-video" autoplay></video>
</div>

<div id="chat-window"></div>

<div class="input-area">
    <input type="text" id="message-input" placeholder="Message टाइप करें..." autocomplete="off">
    <button onclick="sendMessage()">➤</button>
</div>

<script>
    const myIdDisplay = document.getElementById('my-id');
    const peerIdInput = document.getElementById('peer-id');
    const chatWindow = document.getElementById('chat-window');
    const messageInput = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    const statusInfo = document.getElementById('status-info');

    const peer = new Peer(); 
    let conn;
    let typingTimer;

    peer.on('open', id => myIdDisplay.innerText = id);

    // कनेक्शन स्वीकार करना
    peer.on('connection', c => {
        conn = c;
        setupChatListeners();
    });

    function connectToPeer() {
        conn = peer.connect(peerIdInput.value);
        setupChatListeners();
    }

    function setupChatListeners() {
        statusInfo.innerText = "ऑनलाइन";
        
        conn.on('data', data => {
            // 1. Typing status चेक करना
            if (data.type === 'typing') {
                typingIndicator.innerText = data.isTyping ? "टाइपिंग..." : "";
            } 
            // 2. नया मैसेज आने पर
            else if (data.type === 'chat') {
                appendMessage(data.text, 'received', data.id);
                // मैसेज मिल गया, सामने वाले को 'Seen' (Double Tick) भेजें
                conn.send({ type: 'ack', id: data.id });
            } 
            // 3. सामने वाले ने मैसेज देख लिया (Tick Update)
            else if (data.type === 'ack') {
                updateTick(data.id);
            }
        });
    }

    // टाइपिंग इवेंट
    messageInput.addEventListener('input', () => {
        if (!conn) return;
        conn.send({ type: 'typing', isTyping: true });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            conn.send({ type: 'typing', isTyping: false });
        }, 2000);
    });

    // Enter से मैसेज भेजें
    messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });

    function sendMessage() {
        const text = messageInput.value;
        if (conn && text) {
            const msgId = Date.now(); // यूनिक ID
            const msgObj = { type: 'chat', text: text, id: msgId };
            
            conn.send(msgObj);
            appendMessage(text, 'sent', msgId);
            messageInput.value = "";
            conn.send({ type: 'typing', isTyping: false });
        }
    }

    function appendMessage(text, type, id) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.id = `msg-${id}`;
        
        // टिक मार्क (सिर्फ भेजे गए मैसेज के लिए)
        let ticks = type === 'sent' ? `<span class="tick" id="tick-${id}">✓</span>` : "";
        
        div.innerHTML = `${text} <br> ${ticks}`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function updateTick(id) {
        const tickElement = document.getElementById(`tick-${id}`);
        if (tickElement) {
            tickElement.innerHTML = "✓✓"; // डबल टिक
            tickElement.classList.add('seen'); // नीला रंग
        }
    }

    // वीडियो कॉल (Short Version)
    function startVideoCall() {
        document.getElementById('v-con').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            document.getElementById('local-video').srcObject = stream;
            const call = peer.call(peerIdInput.value, stream);
            call.on('stream', rem => document.getElementById('remote-video').srcObject = rem);
        });
    }

    peer.on('call', call => {
        document.getElementById('v-con').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            document.getElementById('local-video').srcObject = stream;
            call.answer(stream);
            call.on('stream', rem => document.getElementById('remote-video').srcObject = rem);
        });
    });
</script>

</body>
</html>